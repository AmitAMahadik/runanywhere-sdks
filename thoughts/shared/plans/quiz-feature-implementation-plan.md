# Quiz Feature Implementation Plan

## Overview
Build a Tinder-like quiz generation feature where users can:
1. Paste educational content/lesson text
2. Generate true/false questions using structured output
3. Swipe through questions (left for false, right for true)
4. View results at the end

## Architecture Design

### 1. Data Models (Using Structured Output)

#### Quiz Generation Models
```swift
// Questions generated by LLM
@Generatable
struct QuizGeneration {
    let questions: [QuizQuestion]
    let topic: String
    let difficulty: String
}

@Generatable
struct QuizQuestion {
    let id: String
    let question: String
    let correctAnswer: Bool
    let explanation: String
    let category: String?
}
```

#### UI State Models
```swift
// User's answer to a question
struct QuizAnswer {
    let questionId: String
    let userAnswer: Bool
    let isCorrect: Bool
    let timeSpent: TimeInterval
}

// Quiz session state
struct QuizSession {
    let id: UUID
    let generatedQuiz: QuizGeneration
    let answers: [QuizAnswer]
    let startTime: Date
    let endTime: Date?
}

// Quiz results
struct QuizResults {
    let session: QuizSession
    let score: Int
    let totalQuestions: Int
    let percentage: Double
    let timeSpent: TimeInterval
    let incorrectQuestions: [QuizQuestion]
}
```

### 2. View Architecture

#### Tab Structure
```
ContentView.swift
├── Tab 0: Chat
├── Tab 1: Models
├── Tab 2: Storage
├── Tab 3: Settings
└── Tab 4: Quiz (NEW)
    └── QuizView.swift (Navigation container)
        ├── QuizInputView.swift (Text input & generation)
        ├── QuizCardView.swift (Swipeable cards)
        └── QuizResultsView.swift (Results display)
```

#### View Components
1. **QuizView.swift** - Main navigation container
2. **QuizInputView.swift** - Text input and question generation
3. **QuizCardView.swift** - Individual swipeable question card
4. **QuizSwipeView.swift** - Swipe gesture handling container
5. **QuizResultsView.swift** - Results display with statistics

### 3. ViewModels

#### QuizViewModel
```swift
@MainActor
class QuizViewModel: ObservableObject {
    @Published var inputText: String = ""
    @Published var isGenerating: Bool = false
    @Published var generatedQuiz: QuizGeneration?
    @Published var currentQuestionIndex: Int = 0
    @Published var answers: [QuizAnswer] = []
    @Published var showResults: Bool = false

    // Token limits
    let maxInputTokens: Int = 3000
    let tokensPerQuestion: Int = 300

    func generateQuiz() async
    func answerQuestion(answer: Bool)
    func calculateResults() -> QuizResults
    func resetQuiz()
}
```

### 4. Implementation Flow

#### Phase 1: Input Processing
1. **Token Counting**
   - Estimate tokens: ~4 characters per token
   - Max input: 3000 tokens (~12,000 characters)
   - Show warning if exceeded

2. **Question Count Calculation**
   ```
   questionCount = min(
       floor(inputTokens / 300),  // 1 question per 300 tokens
       10  // Maximum 10 questions
   )
   ```

#### Phase 2: Quiz Generation
1. **Prompt Construction**
   ```
   Generate [N] true/false questions from this content:
   [USER_CONTENT]

   Requirements:
   - Questions should test understanding, not memorization
   - Mix of difficulty levels
   - Clear, unambiguous questions
   - Provide explanations for each answer
   ```

2. **Structured Output Generation**
   - Use `generateStructured()` with `QuizGeneration` type
   - Handle validation and retry logic
   - Show progress indicator

#### Phase 3: Swipe Interface
1. **Card Stack Implementation**
   - ZStack with offset cards
   - Top card is interactive
   - Show 3 cards at a time (current + 2 preview)

2. **Swipe Gestures**
   - DragGesture with threshold (100 points)
   - Left swipe = False (Red overlay)
   - Right swipe = True (Green overlay)
   - Rotation effect based on drag

3. **Visual Feedback**
   - Color overlays during swipe
   - SF Symbols: checkmark/xmark
   - Haptic feedback on decision

#### Phase 4: Results Display
1. **Statistics**
   - Score and percentage
   - Time spent per question
   - Category breakdown (if available)

2. **Review Section**
   - Incorrect answers with explanations
   - Option to retry missed questions
   - Share results functionality

### 5. User Experience Flow

```
1. User taps Quiz tab
   ↓
2. QuizInputView shown
   - Large text input area
   - Character/token counter
   - "Generate Quiz" button
   ↓
3. User pastes content & taps generate
   - Loading state with progress
   - Model loads if needed
   ↓
4. QuizSwipeView presented
   - First question card shown
   - Swipe instructions overlay (first time)
   ↓
5. User swipes through questions
   - Immediate visual feedback
   - Progress indicator (1/10)
   ↓
6. QuizResultsView shown
   - Score celebration animation
   - Detailed breakdown
   - Options: Review/Retry/New Quiz
```

### 6. Technical Considerations

#### Token Management
```swift
extension String {
    var estimatedTokenCount: Int {
        // Rough estimate: 4 chars = 1 token
        return self.count / 4
    }
}

func calculateQuestionCount(for text: String) -> Int {
    let tokens = text.estimatedTokenCount
    let baseQuestions = tokens / 300
    return min(max(3, baseQuestions), 10) // 3-10 questions
}
```

#### Error Handling
1. **Generation Failures**
   - Retry with simpler prompt
   - Fallback to non-structured generation
   - Clear error messages

2. **Model Loading**
   - Check if model loaded
   - Prompt to load if needed
   - Use same model as chat

#### Performance
1. **Lazy Loading**
   - Generate all questions upfront
   - But create card views lazily

2. **Memory Management**
   - Limit card previews to 3
   - Clean up answered cards

### 7. UI/UX Design

#### Visual Design
1. **Card Design**
   ```
   ┌─────────────────────────┐
   │  Question 1 of 10       │
   │                         │
   │  "The Earth revolves    │
   │   around the Sun"       │
   │                         │
   │  ← False    True →      │
   └─────────────────────────┘
   ```

2. **Color Scheme**
   - True/Right: Green (#34C759)
   - False/Left: Red (#FF3B30)
   - Card background: System background
   - Text: Label color

3. **Animations**
   - Card flip on answer
   - Confetti on high score
   - Smooth transitions

#### Accessibility
1. **VoiceOver Support**
   - Question read aloud
   - Swipe alternatives (buttons)
   - Results announced

2. **Dynamic Type**
   - Scalable text
   - Adjustable card size

### 8. Implementation Phases

#### Phase 1: Core Infrastructure (Day 1)
- [ ] Create data models with @Generatable
- [ ] Set up QuizViewModel
- [ ] Add Quiz tab to ContentView
- [ ] Create basic navigation flow

#### Phase 2: Input & Generation (Day 2)
- [ ] Build QuizInputView
- [ ] Implement token counting
- [ ] Create generation prompt
- [ ] Test structured output generation

#### Phase 3: Swipe Interface (Day 3-4)
- [ ] Create QuizCardView
- [ ] Implement swipe gestures
- [ ] Add visual feedback
- [ ] Build card stack logic

#### Phase 4: Results & Polish (Day 5)
- [ ] Create QuizResultsView
- [ ] Add statistics calculation
- [ ] Implement review functionality
- [ ] Add animations and haptics

#### Phase 5: Testing & Refinement (Day 6)
- [ ] End-to-end testing
- [ ] Performance optimization
- [ ] Error handling improvements
- [ ] UI polish

### 9. Future Enhancements

1. **Advanced Features**
   - Multiple choice questions
   - Difficulty selection
   - Category filtering
   - Time limits

2. **Persistence**
   - Save quiz history
   - Track progress over time
   - Leaderboards

3. **Social Features**
   - Share quizzes
   - Challenge friends
   - Public quiz library

### 10. Success Metrics

1. **Technical**
   - Quiz generation < 5 seconds
   - Smooth 60fps swipe animations

2. **User Experience**
   - 90% completion rate
   - Average session > 5 minutes
   - High retry rate on failed quizzes

This plan provides a comprehensive roadmap for implementing the quiz feature while maintaining consistency with the existing app architecture and leveraging the new structured output capabilities.
